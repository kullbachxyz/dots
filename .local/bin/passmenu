#!/usr/bin/env bash

prefix=${PASSWORD_STORE_DIR-~/.password-store}

# Enable recursive globbing to use **
shopt -s globstar

# Get all password files recursively
password_files=( "$prefix"/**/*.gpg )

# Debug: Print out the password files
echo "Password files:"
printf '%s\n' "${password_files[@]}"

# If there are no files, exit
[[ ${#password_files[@]} -eq 0 ]] && echo "No password files found!" && exit 1

# dmenu command
dmenu_cmd="dmenu -i -fn Hack-10.5"

# Strip prefix and extension for pass
password_files=("${password_files[@]#$prefix/}")
password_files=("${password_files[@]%.gpg}")

# Select password via dmenu
password=$(printf '%s\n' "${password_files[@]}" | $dmenu_cmd "$@")

# Exit if no password selected
[[ -n $password ]] || exit 0

# OTP handling
if [[ $password == *otp* ]]; then
    otp_code=$(pass otp "$password")

    if [[ -z $otp_code ]]; then
        echo "Error generating OTP code!"
        exit 1
    fi

    printf '%s' "$otp_code" | xclip -selection clipboard >/dev/null 2>&1
    notify-send "Pass" "OTP code copied to clipboard."
else
    # Get password (first line only)
    if ! pass_output=$(pass show "$password"); then
        echo "Error retrieving password!"
        exit 1
    fi

    password_line=$(printf '%s\n' "$pass_output" | head -n 1)

    printf '%s' "$password_line" | xclip -selection clipboard >/dev/null 2>&1
    notify-send "Pass" "Password copied to clipboard."
fi

